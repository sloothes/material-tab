<script>

    (function(){
        var component_ID = {
            type: "tab",
            beta: true,
            version: 2.1,
            kind: "component",
            name: "insert.html",
            from: "create.html",
            path: "/material-tab/insert.html",
            description: "creates and inserts outfit material in zangoDB.",
        };
    })();

</script>

<style>

    .selected {
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 142, 255, 1);
    }

    #material-title {
        color:#ffffff;
        background:none;
    }

    .material-value {
        text-align: center;
        font-size: x-large;
        font-weight: bold;
    }

    .x-large {
        font-size: x-large;
    }
    
    .material-property-controls {
        height:72px;
    }

    .uuid-material-textfield {
        width:80%;
    }
    
    .material-textfield {
        width:75%;
        float:right;
    }

    .material-checkbox {
        width:34px;
    }

    .texture-checkbox-helper {
        height:40px;
        margin-top:0px;
        margin-bottom:0px;
    }

    .material-input-number {
        width: 60px;
        padding: 0;
        text-align: right;
        background: none;
        font-weight: bold;
        font-size: 18px;
        border: none;
        color: #ffff;
    }

    .helpers-header h2 { 
        cursor:pointer; 
    }

    #material-property-controls {
        background:none;
        border-radius:8px;
        height:73px;
    }

    .catalog-item {
        width:85px;
        height:85px;
        margin:4px;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }
    
    .sp-container {
        width:100%;
    }

    .sp-picker-container {
        width:93%;
    }

</style>

<script>

    function errorDialogOptions(err){
        return {
            size: "small",
            className: "middle",
            closeButton: true,
            title: `<div class="alert-icon icon-warning">` 
            + `</div><h2 style="margin:auto;">Error!</h2>`,
            message: `<div>Sorry! An error occurred.</div>`
            + `<div>${err}</div>`,
            buttons: {
                cancel: {
                    label: "Close",
                    className: "btn-default",
                },
            },
        };
    }

    function cancelDialogOptions(msg){
        return {
            size: "small",
            className: "middle",
            closeButton: true,
            title: `<div class="alert-icon icon-warning">` 
            + `</div><h2 style="margin:auto;">Canceled</h2>`,
            message: `<div>${msg}</div>`,
            buttons: {
                cancel: {
                    label: "Close",
                    className: "btn-default",
                },
            }
        };
    }

    function successDialogOptions(msg){
        return {
            size: "small",
            className: "middle",
            closeButton: false,
            title: `<div class="alert-icon icon-success">`
            + `</div><h2 style="margin:auto;">Success</h2>`,
            message: `<div>${msg}</div>`,
            buttons: { 
                success: {
                    label: "Close",
                    className: "btn-success",
                    callback: function(){ 
                        bootbox.hideAll(); 
                    }
                },
            }
        };
    }

    function userNotificationDialogMessage(msg){
        return bootbox.dialog({
            buttons: false,
            closeButton: true,
            className: "middle",
            message: `<div class="text-center">${msg}</div>`,
        });
    }

</script>

<script>

//  deepCopy.js

    function deepCopy(obj) {
        if (Object.prototype.toString.call(obj) === "[object Array]") {
            var out = [], i = 0, len = obj.length;
            for ( ; i < len; i++ ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        if (typeof obj === "object") {
            var out = {}, i;
            for ( i in obj ) {
                out[i] = arguments.callee(obj[i]);
            }
            return out;
        }
        return obj;
    }

//  round.js  source: "https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/round"

    function round(number, precision) {
        var shift = function (number, precision, reverseShift) {
            if (reverseShift) {
                precision = -precision;
            }  
            numArray = ("" + number).split("e");
            return +(numArray[0] + "e" + (numArray[1] ? (+numArray[1] + precision) : precision));
        };
        return shift(Math.round(shift(number, precision, false)), precision, true);
    }


</script>

<div class="helpers-header material-header">
    <h2 style="margin-bottom:20px;">Material:</h2>
</div>

<div style="margin-bottom:20px;">
    <input type="text" id="material-title" class="form-control text-center x-large material-title-field" placeholder="new untitled material">
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select gender:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-gender-droplist" class="form-control gender-droplist" readonly>
                <option value="">Select sex:</option>
                <option value="male">male</option>
                <option value="female">female</option>
            </select>
        </div>
    </h4>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select outfit slot:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-outfit-slot" class="form-control outfit-slot-droplist" readonly>
                <option value="">Select slot:</option>
                <option value="body">body</option>
                <option value="eyes">eyes</option>
                <option value="hairs">hairs</option>
                <option value="stockings">stockings</option>
                <option value="underwears">underwears</option>
                <option value="costume">costume</option>
                <option value="tshirt">tshirt</option>
                <option value="trousers">trousers</option>
                <option value="dress">dress</option>
                <option value="shoes">shoes</option>
            </select>
        </div>
    </h4>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select material type:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-type" class="form-control material-type-droplist" readonly>
                <option value="MeshStandardMaterial">standard</option>
                <option value="MeshPhongMaterial">phong</option>
                <option value="MeshLambertMaterial">lambert</option>
                <option value="MeshBasicMaterial">basic</option>
            </select>
        </div>
    </h4>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select property:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-property" class="form-control material-property-droplist" readonly>
                <option value="">Select key:</option>
            </select>
        </div>
    </h4>
</div>

<div id="material-property-controls" class="well"></div>

<div style="margin-bottom:10px;">
    <div id="new-material-button" class="form-control btn btn-primary btn-white-outline gradient-btn pull-left" style="width:24%;">New</div>
    <div id="copy-material-button" class="form-control btn btn-primary btn-white-outline gradient-btn" style="width:24%;margin-left:1%;">Copy</div>
    <div id="apply-material-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:24%;">Apply</div>
    <div id="save-material-button" class="form-control btn btn-success btn-white-outline gradient-btn pull-right" style="width:24%;">Save</div>
</div>

<hr/>

<div class="helpers-header texture-header">
    <h2 style="margin-bottom:20px;">Texture:</h2>
</div>

<div id="material-texture-viewer" style="width:100%;text-align:center;margin-bottom:20px;">
    <img id="material-texture-preview" width="290" height="290" style="margin:auto;">
</div>

<div style="height:45px;margin-bottom:10px;">
    <select id="material-imported-textures" class="form-control material-texture-droplist" readonly>
        <option value="">Select imported texture:</option>
    </select>
</div>

<div id="material-texture-controls" class="well" style="background:none;border-radius:8px;height:auto;display:none;">

    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">Map:</span>
        <input type="checkbox" id="map" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">BumpMap:</span>
        <input type="checkbox" id="bumpMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">EmissiveMap:</span>
        <input type="checkbox" id="emissiveMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">MetalnessMap:</span>
        <input type="checkbox" id="metalnessMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">RoughnessMap:</span>
        <input type="checkbox" id="roughnessMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">DisplacementMap:</span>
        <input type="checkbox" id="displacementMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AOMap:</span>
        <input type="checkbox" id="aoMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">AlphaMap:</span>
        <input type="checkbox" id="alphaMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">LightMap:</span>
        <input type="checkbox" id="lightMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox-helper">
        <span style="vertical-align:-0.7rem;">NormalMap:</span>
        <input type="checkbox" id="normalMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>

</div>

<div style="margin-bottom:20px;">
    <input id="texture-fileinput" type="file" class="hidden" multiple>
    <div id="clear-imported-textures" class="form-control btn btn-danger btn-white-outline gradient-btn pull-left" style="width:24%;">Clear</div>
    <div id="import-texture-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:50%;margin:0 1%;">Import textures</div>
    <div id="delete-selected-texture" class="form-control btn btn-success btn-white-outline gradient-btn pull-right" style="width:24%;">Delete</div>
    <div id="upload-material-textures" class="form-control btn btn-success btn-white-outline gradient-btn pull-right hidden" style="width:24%;">Upload</div>
</div>

<script>

(function(){

    const tab = document.getElementById("material-tab");
    const materialHeaderSelector  = ".material-header";
    const helpersHeaderSelector   = ".helpers-header";
    const materialControlSelector = "#material-property-controls";
    const propertyControlsPanel   = $(tab).find("#material-property-controls").get(0);

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(materialHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( propertyControlsPanel );
    });

})();

</script>

<script>

(function(){

    const tab = document.getElementById("material-tab");
    const viewer = document.getElementById("viewer");
    const contentWindow = viewer.contentWindow;

    const titleTextfield = $(tab).find("input#material-title").get(0);
    const genderDroplist = $(tab).find("#material-gender-droplist").get(0);
    const outfitDroplist = $(tab).find("#material-outfit-slot").get(0);
    const texturePreview = $(tab).find("img#material-texture-preview").get(0);
    const importedTextures = $(tab).find("#material-imported-textures").get(0);
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";

    const slotDroplist = outfitDroplist;

    var Signal = signals.Signal;

    function resetTextureCheckboxes(){
        $(tab).find(textureCheckboxSelector).attr({checked:false});
    }

    function updateTexturePreviewUVImage(){

        if ( importedTextures.value ) return;

        if ( !outfitDroplist.value ) return;
        if ( !genderDroplist.value ) return;

        var slot = outfitDroplist.value;
        var gender = genderDroplist.value;

        if ( !contentWindow[gender][slot] ) return;

        var THREE = contentWindow.THREE; // (must be the scene "THREE") important!
        var geometry = contentWindow[gender][slot].geometry;
        texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    }

//  Gender droplist.
//  1. Changes gender of localPlayer.outfit.
//  2. Stores in localStorage key "Sex" the command.
//  3. Updates texture preview image with outfit slot UV.
//  4. Always have a valid value. (null values not allowed).

    var genderChanged = new Signal();

    $(genderDroplist).on("change", function(){
        genderChanged.dispatch( this.value );
    });

    genderChanged.add(function(value){

    //  Null values NOT allowed!
    //  Restore gender droplist value.

        if ( !value ) {
            genderDroplist.value = contentWindow.localPlayer.outfit.getGender();
            return;
        }

    //  Send command to viewer window.
        var cmd = "/gender/" + value;
        contentWindow.localPlayerHandler(cmd);
    //  Store command to localeStorage.
        store( "Sex", cmd );

    });

    genderChanged.add(resetTextureCheckboxes);
    genderChanged.add(updateTexturePreviewUVImage);


//  Outfit Slot droplist.
//  1. Select outfit slot.
//  2. Updates texture preview image with outfit slot UV.

    var outfitSlotChanged = new Signal();

    $(slotDroplist).on("change", function(){
        outfitSlotChanged.dispatch(this.value);
    });

    outfitSlotChanged.add(function(value){
    //  Null values are allowed!
    //  Send command to viewer window.
        var cmd = "/select/" + value;
        contentWindow.localPlayerHandler(cmd);
    });

    outfitSlotChanged.add(resetTextureCheckboxes);
    outfitSlotChanged.add(updateTexturePreviewUVImage);

})();

</script>

<script>
//  Assuming that zango "USERS" is open.
/*
//  const VERSION = 6;
    const NAME = "USER";

    var db = new zango.Db( NAME, {
        current:    true,
        settings:   true,
        animations: true,
        outfits:    true,
        materials:  true,
        textures:   true,
        products:   true,
    });

    db.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${db.name} (v${db.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });
*/

</script>

<script>

(function(){

    var json;
    var files = {};
    var uploads = [];
    var textures = {};

    const tab = document.getElementById("material-tab");
    const viewer = document.getElementById("viewer");
    const contentWindow    = viewer.contentWindow;

    const genderDroplist   = $(tab).find("select#material-gender-droplist").get(0);
    const slotDroplist     = $(tab).find("select#material-outfit-slot").get(0);
    const typeDroplist     = $(tab).find("select#material-type").get(0);
    const propDroplist     = $(tab).find("select#material-property").get(0);
    const propControls     = $(tab).find("#material-property-controls").get(0);
    const titleTextfield   = $(tab).find("input#material-title").get(0);
    const textureImportBtn = $(tab).find("#import-texture-button").get(0);
    const textureFileinput = $(tab).find("input#texture-fileinput").get(0);
    const textureDeleteBtn = $(tab).find("#delete-selected-texture").get(0);
    const texturesClearBtn = $(tab).find("#clear-imported-textures").get(0);
    const textureUploadBtn = $(tab).find("#upload-material-textures").get(0);
    const textureControls  = $(tab).find("#material-texture-controls").get(0);
    const textureDroplist  = $(tab).find("#material-imported-textures").get(0);
    const texturePreview   = $(tab).find("img#material-texture-preview").get(0);

    const nameInputSelector = "input[type=text]#input_name";
    const textureControlSelector = "#material-texture-controls";
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";

    const materialButtonNew   = $(tab).find("#new-material-button").get(0);
    const materialButtonCopy  = $(tab).find("#copy-material-button").get(0);
    const materialButtonApply = $(tab).find("#apply-material-button").get(0);
    const materialButtonSave  = $(tab).find("#save-material-button").get(0);

    var THREE = contentWindow.THREE; // important!

    function generateUUID(){
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        .replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0;
            var v = c == 'x'?r:r&0x3|0x8;
            return v.toString(16);
        }).toLocaleUpperCase();
    }

    function updateTexturePreviewUVImage(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value ) return;

        var slot = outfitDroplist.value;
        var gender = genderDroplist.value;

        if ( !contentWindow[gender][slot] ) return;

        var THREE = contentWindow.THREE; // (must be the scene "THREE") important!
        var geometry = contentWindow[gender][slot].geometry;
        texturePreview.src = THREE.UVsDebug(geometry, 512).toDataURL();

    }

    function resetTextureCheckboxes(){
        $(tab).find(textureCheckboxSelector).attr({checked:false});
    }

    var Signal = signals.Signal;
    var propertyValueChanged = new Signal();
    var outfitMaterialChanged = new Signal();
    var materialDroplistChanged = new Signal();
    var propertiesDroplistChanged = new Signal();


//  TITLE TEXTFIELD.

    $(titleTextfield).on("input", function(){
        json.name = this.value;
        $(propControls).find(nameInputSelector).val(this.value);
    });


//  SLOT DROPLIST.

    $(slotDroplist).on("change", function(){
        materialDroplistChanged.dispatch();
    });


//  TYPE DROPLIST.

    $(typeDroplist).on("change", function(){
        materialDroplistChanged.dispatch();
    });


//  PROP DROPLIST.

    $(propDroplist).on("change", function(){
        propertiesDroplistChanged.dispatch(this.value);
    });


//  BUTTON NEW.

    $(materialButtonNew).on("click", function(){
        materialDroplistChanged.dispatch();
        outfitMaterialChanged.dispatch();
        debugMode && console.log({"new":json});
    });


//  BUTTON APPLY.

    $(materialButtonApply).on("click", function(){
        outfitMaterialChanged.dispatch();
    });


//  BUTTON COPY.

    $(materialButtonCopy).on("click", function(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value ) return;

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        if ( !contentWindow[gender][slot] ) return;
        var copy = contentWindow[ gender ][ slot ].material.clone();

    //  "materialtoJSON" must be the function of the scene AW3D.js
    //  else does not recognize "color" as instance of THREE.Color.
    //  var materialtoJSON = viewer.contentWindow.materialtoJSON; 

        json = contentWindow.materialtoJSON( copy ); // danger!

        json.name += " copy";
        json._id = ObjectId();  
        json.uuid = generateUUID();

        outfitMaterialChanged.dispatch();
        titleTextfield.value = json.name;

        debugMode && console.log({"copy":json});

    });



//  MATERIAL.

    function newMeshStandardJsonMaterial(){
        return {
            bumpScale: 0.05,
            color: 16777215,
            displacementBias: 0,
            displacementScale: 0,
            emissive: 0,
            emissiveIntensity: 1,
            metalness: 0.5,
            name: "new standard material",
            normalScale: [0, 0],
            opacity: 1,
            roughness: 0.5,
            shading: 2,
            side: 0,
            skinning: true,
            transparent: false,
            type: "MeshStandardMaterial",
            uuid: generateUUID(),
            visible: true,
            wireframe: false,
            _id: ObjectId(),
        };
    }

    function newMeshPhongJsonMaterial(){
        return {
            bumpScale: 0.05,
            color: 16777215,
            displacementBias: 0,
            displacementScale: 0,
            emissive: 0,
            emissiveIntensity: 1,
            name: "new phong material",
            normalScale: [0, 0],
            opacity: 1,
            reflectivity: 1,
            shading: 2,
            shininess: 30,
            side: 0,
            skinning: true,
            specular: 1118481,
            transparent: false,
            type: "MeshPhongMaterial",
            uuid: generateUUID(),
            visible: true,
            wireframe: false,
            _id: ObjectId(),
        };
    }

    function newMeshLambertJsonMaterial(){
        return {
            color: 16777215,
            emissive: 0,
            emissiveIntensity: 1,
            name: "new lambert material",
            opacity: 1,
            reflectivity: 1,
            refractionRatio: 0.98,
            shading: 2,
            side: 0,
            skinning: true,
            transparent: false,
            type: "MeshLambertMaterial",
            uuid: generateUUID(),
            visible: true,
            wireframe: false,
            _id: ObjectId(),
        };
    }

    function newMeshBasicJsonMaterial(){
        return {
            color: 16777215,
            lights: false,
            name: "new basic material",
            opacity: 1,
            reflectivity: 1,
            refractionRatio: 0.98,
            shading: 2,
            side: 0,
            skinning: true,
            transparent: false,
            type: "MeshBasicMaterial",
            uuid: generateUUID(),
            visible: true,
            wireframe: false,
            _id: ObjectId(),
        };
    }

    function newJsonMaterial(){
        return {
            alphaTest: 0,
            blendDst: 205,
            blendEquation: 100,
            blendSrc: 204,
            blending: 1,
            clipShadows: false,
            colorWrite: true,
            depthFunc: 3,
            depthTest: true,
            depthWrite: true,
            fog: true,
            lights: true,
            name: "new material",
            opacity: 1,
            overdraw: 0,
            polygonOffset: false,
            polygonOffsetFactor: 0,
            polygonOffsetUnits: 0,
            premultipliedAlpha: false,
            shading: 2,
            side: 0,
            transparent: false,
            type: "Material",
            uuid: generateUUID(),
            vertexColors: 0,
            visible: true,
            _id: ObjectId(),
        };
    }

    function newJsonTexture() {
        return {
        //  anisotropy: 1,
        //  encoding: 3000,
        //  flipY: true,
        //  format: 1021,
        //  generateMipmaps: true,
        //  magFilter: 1006,
        //  mapping: 300,
        //  minFilter: 1008,
        //  mipmaps: [],
            name: "new texture",
            offset: [0, 0],
        //  premultiplyAlpha: false,
            repeat: [1, 1],
            sourceFile: "",
        //  type: 1009,
        //  unpackAlignment: 4,
            uuid: generateUUID(),
        //  version: 0,
        //  wrapS: 1001,
        //  wrapT: 1001,
            _id: ObjectId(),
        };
    }


    outfitMaterialChanged.add(function(){

        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value) return;

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        var data = {
            slot    : slot,
            gender  : gender,
            material: json,
        };

        contentWindow.localPlayerMaterialHandler(data);
        contentWindow.localPlayerHandler("/select/" + slot);

    });

    propertyValueChanged.add( function(key, value){

        if ( key == undefined ) return;
        if ( !slotDroplist.value ) return;
        if ( !genderDroplist.value) return;

        var data = {};

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        data.key    = key;
        data.value  = value;
        data.slot   = slot;
        data.gender = gender;

        switch( key ) {

            case "map":
            case "alphaMap":
                contentWindow.localPlayerMaterialHandler(data);
            break;

            case "bumpMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "bumpScale",
                    value: json.bumpScale,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "emissiveMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "emissive",
                    value: json.emissive,
                    slot: slot,
                    gender: gender,
                }, {
                    key: "emissiveIntensity",
                    value: json.emissiveIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "displacementMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "displacementBias",
                    value: json.displacementBias,
                    slot: slot,
                    gender: gender,
                }, {
                    key: "displacementScale",
                    value: json.displacementScale,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "lightMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "lightMapIntensity",
                    value: json.lightMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "metalnessMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "metalness",
                    value: json.metalness,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "roughnessMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "roughness",
                    value: json.roughness,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "normalMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "normalScale",
                    value: json.normalScale[0],
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "aoMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "aoMapIntensity",
                    value: json.aoMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "envMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "envMapIntensity",
                    value: json.envMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            default:
                viewer.contentWindow.localPlayerMaterialHandler(data);
            break;
        }

    });


//  MATERIAL CONTROLS.

    function colorControl(key){

        if ( key != "color" ) return;
        var input = document.createElement("input");
        input.type = "hidden"; input.id = `material-input_${key}`;
        $(propControls).append( input ); // (special case) important!

        $(input).spectrum({
            preferredFormat: "hex",
            color: "#ffffff",
            flat: true,
            showInput: true,
            showInitial: true,
            showButtons: false,
            allowEmpty: false,
            move: function(color) {
                var hex = color.toString("hex").replace(/#/, "0x");
                json.color = Number(hex);
                propertyValueChanged.dispatch(key, hex);
            },
        });

    //  Colorpicker startup.
        var hexString = `#${json.color.toString(16)}`;
        $(input).spectrum( "set", hexString );

    }

    function emissiveControl(key){

        if ( key != "emissive" ) return;
        var input = document.createElement("input");
        input.type = "hidden"; input.id = `material-input_${key}`;
        $(propControls).append( input ); // (special case) important!

        $(input).spectrum({
            preferredFormat: "hex",
            color: "#000000",
            flat: true,
            showInput: true,
            showInitial: true,
            showButtons: false,
            allowEmpty: false,
            move: function(color) {
                var hex = color.toString("hex").replace(/#/, "0x");
                json.emissive = Number(hex);
                propertyValueChanged.dispatch(key, hex);
            },
        });

    //  Colorpicker startup.
        var hexString = `#${json.emissive.toString(16)}`;
        $(input).spectrum( "set", hexString );

    }

    function _idControl(key){

        if ( key != "_id" ) return;

        var control = document.createElement("div");

        var button = document.createElement("div");
        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
        button.id = `material-button${key}`; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

        var input = document.createElement("input");
        input.id = `material-input${key}`; input.type = "text"; input.readOnly = true;
        input.classList.add("form-control", "text-center", "pull-right", "uuid-material-textfield");

        input.value = json[key]; // ObjectId();

        $(button).on("click", function(){
            input.value = json[key] = ObjectId();
        });

        $(control).append(button, input);

        return control;
    }

    function uuidControl(key){

        if ( key != "uuid" ) return;

        var control = document.createElement("div");

        var button = document.createElement("div");
        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
        button.id = `material-button_${key}`; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

        var input = document.createElement("input");
        input.id = `material-input_${key}`; input.type = "text"; input.readOnly = true;
        input.classList.add("form-control", "pull-right", "uuid-material-textfield");

        input.value = json[key]; // generateUUID();

        $(button).on("click", function(){
            input.value = json[key] = generateUUID();
        });

        $(control).append(button, input);

        return control;
    }

    function nameControl(key){

        if ( key != "name" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-1rem;";

        var input = document.createElement("input"); 
        input.id = `material-input_${key}`; input.type = "text";
        input.classList.add("form-control", "pull-right", "material-textfield");

        input.value = json[key];

        $(input).on("input", function(){
            json[key] = this.value;
        });

        $(control).append(span, input);

        return control;
    }

    function typeControl(key){

        if ( key != "type" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `material-input_${key}`;  
        input.type = "text"; input.readOnly = true;
        input.classList.add("form-control", "pull-right", "material-textfield");

        input.value = json.type;

        $(control).append(span, input);

        return control;

    }

    function bumpScaleControl(key){

        if ( key != "bumpScale" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.id = `material-input_${key}`; input.type = "number"; input.step = 0.01;
        input.classList.add("form-control", "pull-right", "material-input-number");

        input.value = json.bumpScale;

        $(input).on("input", function(){
            var value = round(this.value, 2);
            json.bumpScale = value;
            propertyValueChanged.dispatch(key, value);
        });

        $(control).append(span, input);

        return control;

    }

    function displacementScaleControl(key){

        if ( key != "displacementScale" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.classList.add("form-control", "pull-right", "material-input-number");
        input.id = `material-input_${key}`; input.type = "number"; input.step = 0.01;

        input.value = json.displacementScale;

        $(input).on("input", function(){
            var value = round(this.value, 2);
            json.displacementScale = value;
            propertyValueChanged.dispatch(key, value);
        });

        $(control).append(span, input);

        return control;

    }

    function displacementBiasControl(key){

        if ( key != "displacementScale" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.classList.add("form-control", "pull-right", "material-input-number");
        input.id = `material-input_${key}`; input.type = "number"; input.step = 0.01;

        input.value = json.displacementBias;

        $(input).on("input", function(){
            var value = round(this.value, 2);
            json.displacementBias = value;
            propertyValueChanged.dispatch(key, value);
        });

        $(control).append(span, input);

        return control;

    }

    function normalScaleControl(key){

        if ( key != "normalScale" ) return;

        var control = document.createElement("div");

        var span = document.createElement("span");
        span.innerText = key; span.style.cssText = "vertical-align:-0.7rem;";

        var input = document.createElement("input"); 
        input.classList.add("form-control", "pull-right", "material-input-number");
        input.id = `material-input_${key}`; input.type = "number"; input.step = 0.01;

        if ( json.normalScale && Array.isArray(json.normalScale) ) {
            input.value = json.normalScale[0];
        }

        $(input).on("input", function(){
            var value = round(this.value, 2);
            propertyValueChanged.dispatch(key, value );
            json.normalScale[0] = json.normalScale[1] = value;
        });

        $(propControls).slideDown();
        $(propControls).append(span, input);

    }




//  MATERIAL PROPERTY DROPLIST.

    propertiesDroplistChanged.add(function(key){

        $(propControls).children().remove();

        if ( !key ) return;

        $(propControls).css({height:""});

        switch (key) {

            case "color":
                colorControl(key); // special case!
                $(propControls).css({height:"auto"});
            break;

            case "emissive":
                emissiveControl(key); // special case!
                $(propControls).css({height:"auto"});
            break;

            case "_id":
                $(propControls).append( _idControl(key) );
            break;

            case "uuid":
                $(propControls).append( uuidControl(key) );
            break;

            case "name":
                $(propControls).append( nameControl(key) );
            break;

            case "type":
                $(propControls).append( typeControl(key) );
            break;

            case "bumpScale":
                $(propControls).append( bumpScaleControl(key) );
            break;

            case "displacementScale":
                $(propControls).append( displacementScaleControl(key) );
            break;

            case "displacementBias":
                $(propControls).append( displacementBiasControl(key) );
            break;

            case "normalScale":
                $(propControls).append( normalScaleControl(key) );
            break;

            case "visible":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "visible"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_visible"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.visible || "";

                    $(input).on("click", function(){
                        json.visible = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "opacity":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "opacity"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_opacity"; input.type = "number"; 
                    input.step = 0.01; input.min = 0; input.max = 1;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.opacity;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.opacity = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "transparent":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "transparent"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_transparent"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.transparent || "";

                    $(input).on("click", function(){
                        json.transparent = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "skinning":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "skinning"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_skinning"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.skinning || "";

                    $(input).on("click", function(){
                        json.skinning = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "wireframe":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "wireframe"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_wireframe"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.wireframe || "";

                    $(input).on("click", function(){
                        json.wireframe = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "fog":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "fog"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_fog"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.fog || "";

                    $(input).on("click", function(){
                        json.fog = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "lights":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "lights"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_lights"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.lights || "";

                    $(input).on("click", function(){
                        json.lights = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "emissiveIntensity":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "emissiveIntensity"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_emissiveIntensity"; input.type = "number";  input.step = 0.01;

                    input.value = json.emissiveIntensity;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.emissiveIntensity = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "lightMapIntensity":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "lightMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_lightMapIntensity"; input.type = "number";  input.step = 0.01;

                    input.value = json.lightMapIntensity;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.lightMapIntensity = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "aoMapIntensity":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "aoMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_aoMapIntensity"; input.type = "number";  input.step = 0.01;

                    input.value = json.aoMapIntensity;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.aoMapIntensity = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "colorWrite":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "colorWrite"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_colorWrite"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.colorWrite || "";

                    $(input).on("click", function(){
                        json.colorWrite = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "clipShadows":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "clipShadows"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_clipShadows"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.clipShadows || "";

                    $(input).on("click", function(){
                        json.clipShadows = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;
        /*
            case "alphaTest":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "alphaTest"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_alphaTest"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = Boolean(json.alphaTest) || "";

                    $(input).on("click", function(){
                        var value = Number(this.checked);
                        json.alphaTest = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;
        */
            case "depthTest":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "depthTest"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_depthTest"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.depthTest || "";

                    $(input).on("click", function(){
                        json.depthTest = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "depthWrite":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "depthWrite"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_depthWrite"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.depthWrite || "";

                    $(input).on("click", function(){
                        json.depthWrite = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "depthFunc":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "depthFunc"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.min = 0; input.max = 7; input.step = 1;
                    input.id = "input_depthFunc"; input.type = "number";  
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.depthFunc;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.depthFunc = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "morphNormals":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "morphNormals"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_morphNormals"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.morphNormals || "";

                    $(input).on("click", function(){
                        json.morphNormals = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "morphTargets":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "morphTargets"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_morphTargets"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.morphTargets || "";

                    $(input).on("click", function(){
                        json.morphTargets = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "refractionRatio":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "refractionRatio"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_refractionRatio"; input.type = "number";  input.step = 0.01;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.refractionRatio;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.refractionRatio = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "metalness":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "metalness"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_metalness"; input.type = "number";  input.step = 0.01;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.metalness;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.metalness = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "roughness":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "roughness"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_roughness"; input.type = "number";  input.step = 0.01;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.roughness;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.roughness = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "shading":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "shading"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_shading"; input.type = "number"; 
                    input.step = 1; input.min = 1; input.max = 2;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.shading;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.shading = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "side":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "side"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_side"; input.type = "number"; 
                    input.step = 1; input.min = 0; input.max = 2;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.side;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.side = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "wireframeLinewidth":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "wireframeLinewidth"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_wireframeLinewidth"; 
                    input.type = "number"; input.step = 1; input.min = 1;
                    input.classList.add("form-control", "pull-right", "material-input-number");

                    input.value = json.wireframeLinewidth;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.wireframeLinewidth = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "wireframeLinecap":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "wireframeLinecap"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_wireframeLinecap"; input.type = "text"; 
                    input.style.cssText = "width:40%;"; input.readOnly = true;
                    input.classList.add("form-control", "pull-right", "material-textfield"); 

                    input.value = json.wireframeLinecap;

                    $(propControls).append(span, input);

                })();

            break;

            case "wireframeLinejoin":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "wireframeLinejoin"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_wireframeLinejoin"; input.type = "text"; 
                    input.style.cssText = "width:40%;"; input.readOnly = true;
                    input.classList.add("form-control", "pull-right", "material-textfield"); 

                    input.value = json.wireframeLinejoin;

                    $(propControls).append(span, input);

                })();

            break;

            case "polygonOffset":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "polygonOffset"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.id = "input_polygonOffset"; input.type = "checkbox"; 
                    input.classList.add("form-control", "pull-right", "material-checkbox");

                    input.checked = json.polygonOffset || "";

                    $(input).on("click", function(){
                        json.polygonOffset = this.checked;
                        propertyValueChanged.dispatch(key, this.checked);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "polygonOffsetFactor":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "polygonOffsetFactor"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_polygonOffsetFactor"; input.type = "number"; input.step = 1;

                    input.value = json.polygonOffsetFactor;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.polygonOffsetFactor = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "polygonOffsetUnits":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "polygonOffsetUnits"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_polygonOffsetUnits"; input.type = "number"; input.step = 1;

                    input.value = json.polygonOffsetUnits;

                    $(input).on("input", function(){
                        var value = parseInt(this.value);
                        json.polygonOffsetUnits = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

            case "envMapIntensity":

                (function(){

                    var span = document.createElement("span");
                    span.innerText = "envMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";

                    var input = document.createElement("input"); 
                    input.classList.add("form-control", "pull-right", "material-input-number");
                    input.id = "input_envMapIntensity"; input.type = "number";  input.step = 0.01;

                    input.value = json.envMapIntensity;

                    $(input).on("input", function(){
                        var value = round(this.value, 2);
                        json.envMapIntensity = value;
                        propertyValueChanged.dispatch(key, value);
                    });

                    $(propControls).append(span, input);

                })();

            break;

        }

        $(propControls).slideDown();

    });


//  MATERIAL TYPE DROPLIST.
//  1.materialDroplistChanged

    materialDroplistChanged.add(function(){

    //  Create new json material.

        var type = typeDroplist.value;

        switch ( type ) {

            case "MeshStandardMaterial":
                json = newMeshStandardJsonMaterial();
            break;

            case "MeshPhongMaterial":
                json = newMeshPhongJsonMaterial();
            break;

            case "MeshLambertMaterial":
                json = newMeshLambertJsonMaterial();
            break;

            case "MeshBasicMaterial":
                json = newMeshBasicJsonMaterial();
            break;

            default:
                json = newMeshStandardJsonMaterial();
            break;
        }

    });

//  2.materialDroplistChanged

    materialDroplistChanged.add(function(){

        titleTextfield.value = json.name;

        if ( !json._id ) json._id = ObjectId();
        if ( !json.uuid) json.uuid = generateUUID();

        $(propDroplist).children().remove();
        $(propControls).children().remove();

    //  Sort json keys.
        var sortedKeys = Object.keys(json).sort();
        for ( var i = 0; i < sortedKeys.length; i++ ) {

            var key = sortedKeys[i];
            var option = document.createElement("option");

            option.value = key; 
            option.innerText = key;

            $(propDroplist).append(option);

        }

        propertiesDroplistChanged.dispatch(propDroplist.value);

    });



//  TEXTURE.

    const maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
        "aoMap", 
        "envMap",
    ];

    maps.forEach(function( key ){
        $(textureControls).find(`input#${key}`).on("click", function(){

            if (!textureDroplist.value) return;

            var name = textureDroplist.value;

            if ( !this.checked ) {

                var object = null;
                delete json[ key ];

            } else {

                var object  = textures[ name ];  //  json texture.
                json[ key ] = textures[ name ];  //  json texture.

            }

            propertyValueChanged.dispatch( key, object );

        });
    });

    function warningDialogOptions(msg){
        return {
            size: "small",
            className: "middle",
            title: `<div class="alert-icon icon-warning"></div>`
            + `<h2 style="margin:auto;">Sorry!</h2>`,
            message: `<div>${msg}</div>`,
            buttons: {
                cancel: {
                    label: "Close",
                    className: "btn-default",
                    callback: function(){
                        debugMode && console.log(msg);
                    },
                },
            },
        };

    }

//  BUTTON IMPORT.

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){

        if ( this.files.length == 0 ) return;

        resetTextureCheckboxes();

        for (var i = 0; i < this.files.length; i++ ) {

            (function(){

                var file = textureFileinput.files[i];
                var name = textureFileinput.files[i].name;

                if ( name in files && file.lastModified == files[name].lastModified 
                    && file.size == files[name].size && file.type == files[name].type ) {

                        return;

                } else {

                /*
                    files[ name ] = file;

                    var reader = new FileReader();
                    reader.onload = function() {

                        textures[ name ] = newJsonTexture();
                        textures[ name ].sourceFile = reader.result;
                        textures[ name ].name = name;

                        var option = document.createElement("option");
                        option.id = textures[ name ]._id;
                        option.value = option.innerText = name;

                        $(textureDroplist).append(option);

                    };

                    reader.readAsDataURL(files[ name ]);
                */

                    files[ name ] = file;

                    textures[ name ] = newJsonTexture();
                    textures[ name ].name = name;
                    textures[ name ].sourceFile = URL.createObjectURL( files[name] ); // DO NOT REVOKE! important!

                    var option = document.createElement("option");
                    option.id = textures[ name ]._id;
                    option.value = option.innerText = name;
                    $(textureDroplist).append(option);

                }

            })();

        }

        debugMode && console.log({
            "files": files, 
            "textures": textures,
        });

    });

//  SELECT TEXTURE DROPLIST.

    $(textureDroplist).on("change", function(){

        resetTextureCheckboxes();

        if ( this.value ) {

            $(textureControls).slideDown();
            texturePreview.src = textures[ this.value ].sourceFile;

        } else {

            $(textureControls).slideUp();
            updateTexturePreviewUVImage();

        }

    });

//  BUTTON DELETE.

    $(textureDeleteBtn).on("click", function(){

        var option = textureDroplist.selectedOptions[0];

        if ( !option ) return;
        if ( !option.value ) return;

        var name = option.value;
        var objectURL = textures[ name ].sourceFile; // files[option.value];
        debugMode && console.log(objectURL);

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            $(option).remove();

            resetTextureCheckboxes();
            $(textureDroplist).change();
            $(textureControls).slideUp();

        //  Optional.

            URL.revokeObjectURL( objectURL );
            delete files[ option.value ];
            delete textures[ option.value ];
            debugMode && console.log({"files":files, "textures": textures});

        }, 250 );

    });

//  BUTTON CLEAR.

    $(texturesClearBtn).on("click", function(){

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){
            debugMode && console.log({"files":files, "textures": textures});

            $(textureDroplist).children().remove();
            var option = document.createElement("option");
            option.value = "";  option.innerText = "Select imported texture:";
            $(textureDroplist).append(option);

            resetTextureCheckboxes();
            $(textureControlSelector).slideUp();

        //  Optional.

            for (var name in textures){

                var objectURL = files[name];
                ULR.revokeObjectURL( objectURL );

                delete files[name];
                delete textures[name];

            }

        //  files = {}; textures = {};

        }, 250 );

    });

//  BUTTON UPLOAD (hidden).

    $(textureUploadBtn).on("click", function(){
        debugMode && console.log({"uploads":uploads});

        if ( !uploads.length ) {
            var msg = "There is nothing to upload.";
            return bootbox.dialog( warningDialogOptions(msg) );
        }

        if ( !navigator.onLine ) {
            var msg = "Your connection to the internet is down.";
            return bootbox.dialog( warningDialogOptions(msg) );
        }

        clearTimeout(this.interval);
        this.interval = setTimeout( function(){

            while( uploads.length ){
                uploads.shift().call();
            }

        }, 250 );

    });

//  BUTTON SAVE.

    var materialSaveButtonClicked = new Signal();

    $(materialButtonSave).on("click", function(){

        if ( !json._id ) json._id = ObjectId();  
        if ( !json.uuid ) json.uuid = generateUUID();  

        if ( !json.name ) {

            var defaultName = "untitled material";
            var title = `<div class="alert-icon icon-warning"></div>`
            + `<h2 style="margin:auto;">Name required</h2>`
            + `<div>Please type a name for this material</div>`;

            return bootbox.prompt({
                title: title,
                size: "small",
                className: "middle",
                value: defaultName,
                closeButton: false,
                callback: callback,
            });

            function callback(result){

                var msg = `Save aborted.`;
                var err = `Name is required. Save canceled.`;

                titleTextfield.value = result;  // optional!
                debugMode && console.log({"result":result});

                if ( result == defaultName ) {
                    return $(materialButtonSave).click();
                } else if ( result == null ) {
                    return bootbox.dialog( cancelDialogOptions(msg) );
                } else if ( result.length == 0 ) {
                    return bootbox.dialog( errorDialogOptions(err) );
                } else {
                    json.name = result;
                    titleTextfield.value = json.name;  // optional!
                    return materialSaveButtonClicked.dispatch();
                }
            }

        }

        materialSaveButtonClicked.dispatch();

    });

    //  Validate json.
    /*
        if ( window.validator ) {
            if (!(function(){
                var str = JSON.stringify(json);
                return validator.isJSON( str );
            })()) throw "json is not valid";
        }
    */

    materialSaveButtonClicked.add( function(){

    //  Material metadata.

        json.meta = {};
        json.meta.slot = slotDroplist.value;
        json.meta.gender = genderDroplist.value;
        debugMode && console.log({"json":json});

    //  Insert to collection.

        var collection = db.collection("materials");
        debugMode && console.log({"collection":collection});

        collection.insert(json, function(err){
            if (err) throw err;
        }).then(function(){

        //  Upload texture images (in background).
            var selector = {_id:json._id};
            return collection.findOne(selector, function(err){
                if (err) throw err;
            }).then(function(doc){
                return doc;
            });

        }).then(function(doc){
            debugMode && console.log("inserted material:", doc);

            if (!doc) throw `material ${json._id} could not be found!`;

        //  Filter duplicate textures.

            var textureMaps = maps.filter(function(map){
                return ( doc[ map ] != undefined );
            });

            debugMode && console.log("textureMaps:", textureMaps);

        //  First pass (collect data).

            var textureImages = {};

            textureMaps.forEach(function( key ){
                if ( !doc[ key ] ) return;
                var texture = doc[ key ];
                if ( texture.sourceFile && texture.name ) {
                    var name = texture.name;
                    if ( textureImages[ name ] == undefined ) {
                        textureImages[ name ] = { 
                            name: name,
                            maps: [ key ],
                            data: texture.sourceFile,  // texture.sourceFile.split(";base64,").pop(), // important!
                            type: files[ name ].type,  // texture.sourceFile.split(";base64,").shift().replace("data:", ""),
                        };
                    }
                }
            });

            if ( textureImages === {} ) throw "None textures found.";

        //  Second pass (collect mapkeys).

            debugMode && console.log( {"textureImages": textureImages} );

            textureMaps.forEach(function( key ){
                if ( !doc[ key ] ) return;
                var name = doc[ key ].name;
                if ( !textureImages[ name ] ) return;
                if ( !textureImages[ name ].maps ) return;
                if ( !textureImages[ name ].maps.includes(key) ) {
                    textureImages[ name ].maps.push( key );
                }
            });

        //  Third pass (upload images in background).

            debugMode && console.log( {"textureImages": textureImages} );

            for (var name in textureImages ) {

                (function(){

                    var file = files[ name ];
                    var selector = {_id:json._id};
                    var item = textureImages[ name ];

                    uploads.push( function(){
                        new Promise(function(resolve, reject){

                            var formdata = new FormData();
                            formdata.append("image", file);
                            formdata.append("type",  file.type);
                            formdata.append("name",  file.name);

                            var xhttp = new XMLHttpRequest();
                            var endpoint = "https://api.imgur.com/3/image";
                            var clientid = "60db267c697bb33";  // textures app Client-ID.
                            xhttp.open('POST', endpoint, true);
                            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
                            xhttp.onreadystatechange = function () {
                                if (this.readyState === 4) {
                                    var response = "";
                                    if (this.status >= 200 && this.status < 300) {
                                        response = JSON.parse(this.responseText);
                                        resolve( response ); // resolve promise.
                                    } else {
                                        var err = JSON.parse(this.responseText).data.error;
                                        console.error("TextureUploadError:", err.type, err);
                                        throw err;
                                    }
                                }
                            };

                            xhttp.send(formdata);
                            xhttp = null;

                        }).then( function( response ){

                            var data = response.data;

                        //  Add to cache.
                            caches.open("textures").then(function(cache){
                                cache.add(data.link);

                            //  Update material doc.

                                var modifier = {$set:{}};

                                item.maps.forEach(function(mapkey){

                                    var imagekey = `${mapkey}.image`;        // mapkey + ".image";
                                    var sourcekey = `${mapkey}.sourceFile`;  // mapkey + ".sourceFile";
                                    modifier.$set[ imagekey ] = data.link;
                                    modifier.$set[ sourcekey ] = data.link;

                                //  texture metadata. (optional).
                                    var textureMetakey  = `${mapkey}.meta`;   // mapkey + ".meta";
                                    var materialMetakey = `meta.${mapkey}`;   // "meta." + mapkey;
                                    modifier.$set[ textureMetakey ] = data.id;
                                    modifier.$set[ materialMetakey ] = data.id;

                                });

                                debugMode && console.log(modifier);

                                collection.update(selector, modifier, function(err){
                                    if (err) throw err;
                                }).then( function(){
                                    console.log(`Texture ${data.name} uploaded successfully!`);
                                }).catch(function(err){
                                    console.error(err);
                                    throw err;
                                });

                            });

                        }).catch(function(err){
                            console.error(err);
                            bootbox.dialog( errorDialogOptions(err) );
                        });

                    }); // end of push().

                })();

            }

            debugMode && console.log({"uploads": uploads});

        }).then(function(){

            if ( navigator.onLine ) {
                while ( uploads.length ) {
                    uploads.shift().call();
                }
            }

        }).then(function(){

        //  Success.

            if (uploads.length == 0) {
                var msg = `Material ${json.name} has been saved!`;
                userNotificationDialogMessage(msg);
            }

            resetTextureCheckboxes();
            materialDroplistChanged.dispatch();

        }).catch(function(err){
            console.error(err);
            bootbox.dialog( errorDialogOptions(err) );
        });

    });


//  on Startup.

    materialDroplistChanged.dispatch(); // important!

})();

</script>

