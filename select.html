<script>
    $(function(){
        var component_ID = {
            type: "tab",
            demo: true,
            version: 1.0,
            kind: "component",
            name: "select-material-tab.html",
            description: "select (read) outfit material in zangoDB.",
        };
    });
</script>

<style>

    .helpers-header h3 { cursor:pointer; }

    #collection-items {
        max-width:475px;
        max-height:660px;
        color:#fff;
        border:none;
        padding:0px;
        background-color:#fff0;
    }

    #display-documents {
        max-height:340px;
        overflow:auto;
    }

    .page-btn {
        max-width:45px;
        padding:6px 10px;
    }

</style>

<div class="helpers-header costume-header" style="margin-bottom:20px;">
    <h3>Select material:</h3>
</div>

<div id="display-materials" class="tab-content">

    <div class="helpers-header gender-header">
        <h4 style="margin-bottom:30px;">
            <span style="vertical-align:-0.5rem;">Select gender:</span>
            <div style="display:inline-block;width:50%;float:right;">
                <select id="outfit-gender-droplist" class="form-control gender droplist" readOnly>
                    <option value="">Select sex:</option>
                    <option value="male">male</option>
                    <option value="female">female</option>
                </select>
            </div>
        </h4>
    </div>

    <div>
        <h4 style="margin-bottom:30px;">
            <span style="vertical-align:-0.5rem;">Select outfit slot:</span>
            <div style="display:inline-block;width:50%;float:right;">
                <select id="outfit-slot-droplist" class="form-control outfit helper slots" readOnly>
                    <option value="">Select slot:</option>
                    <option value="body">body</option>
                    <option value="eyes">eyes</option>
                    <option value="hairs">hairs</option>
                    <option value="stockings">stockings</option>
                    <option value="underwears">underwears</option>
                    <option value="costume">costume</option>
                    <option value="tshirt">tshirt</option>
                    <option value="trousers">trousers</option>
                    <option value="dress">dress</option>
                    <option value="shoes">shoes</option>
                </select>
            </div>
        </h4>
    </div>

    <div id="collection-items" class="well">

        <h4>Choose material:
            <div id="counter" class="pull-right small" style="margin-top:4px;color:#ddd;">
                <span id="from">zero</span>
                to <span id="upto">zero</span>
                of <span id="count">none</span>
            </div>
        </h4>

        <div class="pager">
            <div style="margin:10px 0px 10px;">
                <li class="btn btn-primary get-prev-btn pull-left">&#9668;</li>
                <div class="pager-buttons-holder" style="display:inline;">
                    <a class="btn btn-default page-btn">1</a>
                    <a class="btn btn-default page-btn">2</a>
                    <a class="btn btn-default page-btn">3</a>
                    <a class="btn btn-default page-btn">4</a>
                </div>
                <li class="btn btn-primary get-next-btn pull-right">&#9658;</li>
            </div>

            <div id="display-documents" class="panel-container"></div>

            <div style="margin:10px 0px 20px;">
                <li class="btn btn-primary btn-white-outline first-page-btn pull-left" style="margin-right:5px;">First</li>
                <li class="btn btn-primary btn-white-outline get-prev-group-btn pull-left">&#9668;&#9668;</li>
                <li class="btn btn-primary btn-white-outline last-page-btn pull-right" style="margin-left:5px;">Last</li>
                <li class="btn btn-primary btn-white-outline get-next-group-btn pull-right">&#9658;&#9658;</li>
            </div>
        </div>

    </div>

</div>

<hr/>

<script>

loadjs(["/three/three.js"], function(){

    const DB = new zango.Db( "USER", {
        materials:  true,
    });

    DB.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${DB.name} (v${DB.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });

    var skip = 0;
    var page = 1;
    var max = 100;

    const limit = 10;
    const collection = DB.collection("materials");

    const viewer = document.getElementById("viewer");
    const slotDroplist = $("#display-materials").find("#outfit-slot-droplist").get(0);
    const genderDroplist = $("#display-materials").find("#outfit-gender-droplist").get(0);
    const displayObjects = $("#display-materials").find("#display-documents").get(0);

    var Signal = signals.Signal;
    var droplistChanged = new Signal();
    var materialSelected = new Signal();

    materialSelected.add(function(json){

        var data = {
            material: json,
            slot: json.meta.slot,
            gender: json.meta.gender,
        };

        if ( window.socket ) {
            socket.publish(localPlayerMaterialChannel, data); // demo!
        } else {
            viewer.contentWindow.localPlayerApplyMaterial(data);
        }

    });

    droplistChanged.add(function(){

        var slot = slotDroplist.value;
        var gender = genderDroplist.value;

        var selectors = { 
            "meta.slot": slot,
            "meta.gender": gender,
        };

        collection.find(selectors).skip(skip)
        .limit(limit).toArray(function(err){
            if (err) throw err;
        }).then(function(docs){

            $(displayObjects).children().remove();
            debugMode && console.log({"docs":docs});

            docs.forEach(function(json){
                var element = document.createElement("div");
                element.style.cursor = "pointer";
                element.classList.add("form-control", "material-item");
                element.id = json._id; element.innerText = element.title = json.name;

                $(element).on("click", function(){
                    clearTimeout(this.interval);
                    this.interval = setTimeout( function(){
                        materialSelected.dispatch(json);
                    }, 250 );
                });

                $(displayObjects).append( element );
            });

        }).catch(function(err){
            console.error(err);
        });

    });

    $(slotDroplist).on("change", function(){
        droplistChanged.dispatch();
    });

    $(genderDroplist).on("change", function(){
        droplistChanged.dispatch();
    });

    async function count(){
        var k = 0; 
        await collection.find()
        .forEach(async function(){
            ++k;
        });
        return k;
    }

    $(".get-prev-btn").on("click", function(){
        if ( page - 1 > 0 ) --page;
        debugMode && console.log({"page":page});
    });

    $(".get-next-btn").on("click", function(){
        if ( page + 1 < max ) ++page;
        debugMode && console.log({"page":page});
    });

});

</script>
