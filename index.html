<script>

    $(function(){
        var component_ID = {
            type: "tab",
            demo: true,
            version: "1.3.1",
            kind: "component",
            name: "material-tab.html",
            description: "creates outfit material in zangoDB.",
        };
    });

</script>

<style>

    .selected {
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 142, 255, 1);
    }

    #material-title {
        color:#ffffff;
        background:none;
    }

    .material-value {
        text-align: center;
        font-size: x-large;
        font-weight: bold;
    }
    
    .material-textfield {
        width:70%;
        float:right;
    }

    .x-large {
        font-size: x-large;
    }
    
    .material-property-controls {
        height:72px;
    }

    .material-textfield {
        width:75%;
    }

    .uuid-material-textfield {
        width:80%;
    }

    .material-checkbox {
        width:34px;
    }

    .texture-checkbox {
        height:40px;
        margin-top:0px;
        margin-bottom:0px;
    }

    .material-input-number {
        width: 60px;
        padding: 0;
        text-align: right;
        background: none;
        font-weight: bold;
        font-size: 18px;
        border: none;
        color: #ffff;
    }

    .helpers-header h2 { 
        cursor:pointer; 
    }

    #material-property-controls {
        background:none;
        border-radius:8px;
        height:73px;
    }

    .catalog-item {
        width:85px;
        height:85px;
        margin:4px;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }
    
    .sp-container {
        width:100%;
    }

    .sp-picker-container {
        width:93%;
    }


</style>

<div class="helpers-header material-header" style="margin-bottom:20px;">
    <input type="text" id="material-title" class="form-control text-center x-large material-title-field" placeholder="new untitled material" readonly>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select gender:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-gender-droplist" class="form-control gender droplist" readonly>
                <option value="">Select sex:</option>
                <option value="male">male</option>
                <option value="female">female</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const droplist = document.getElementById("material-gender-droplist");
    const outfitHelpersTabSelector = ".outfit-helpers.component-pane.tab-pane";

    var Signal = signals.Signal;
    var genderChanged = new Signal();

    genderChanged.add(function(value){
        if ( !value ) return;

        var data = "/gender/" + value;
        viewer.contentWindow.localPlayerHandler(data);
        store( "Sex", data );

    });

    $(droplist).on("change", function(){
        if ( !this.value ) return;
        genderChanged.dispatch( this.value );
    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select outfit slot:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="outifit-slot" class="form-control outfit-slot-droplist" readonly>
                <option value="">Select slot:</option>
                <option value="body">body</option>
                <option value="eyes">eyes</option>
                <option value="hairs">hairs</option>
                <option value="stockings">stockings</option>
                <option value="underwears">underwears</option>
                <option value="costume">costume</option>
                <option value="tshirt">tshirt</option>
                <option value="trousers">trousers</option>
                <option value="dress">dress</option>
                <option value="shoes">shoes</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const droplist = $("select#outifit-slot").get(0);

    var Signal = signals.Signal;
    var outfitSlotChanged = new Signal();

    outfitSlotChanged.add(function(value){
        if ( !value ) return;
        var data = "/select/" + value;
        viewer.contentWindow.outfitSelectHandler(data);

    });

    $(droplist).on("change", function(){
        if (!this.value) return;
        outfitSlotChanged.dispatch(this.value);
    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select material type:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-type" class="form-control material-type-droplist" readonly>
                <option value="MeshStandardMaterial">standard</option>
                <option value="MeshPhongMaterial">phong</option>
                <option value="MeshLambertMaterial">lambert</option>
                <option value="MeshBasicMaterial">basic</option>
            </select>
        </div>
    </h4>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select property:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-property" class="form-control material-property-droplist" readonly>
                <option value="">Select key:</option>
            </select>
        </div>
    </h4>
</div>

<div id="material-property-controls" class="well"></div>

<div class="helpers-header texture-header">
    <h2 style="margin-bottom:20px;">Textures:</h2>
</div>

<div style="margin-bottom:20px;">
    <div id="import-texture-button" class="form-control btn btn-info btn-white-outline gradient-btn">Import textures</div>
    <input id="texture-fileinput" type="file" class="hidden">
</div>

<div style="height:45px;margin-bottom:20px;">
    <select id="imported-textures" class="form-control material-texture-droplist" readonly>
        <option value="">Select imported texture:</option>
    </select>
</div>

<div id="material-texture-controls" class="well" style="background:none;border-radius:8px;height:auto;">

    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">Map:</span>
        <input type="checkbox" id="map" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">BumpMap:</span>
        <input type="checkbox" id="bumpMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">EmissiveMap:</span>
        <input type="checkbox" id="emissiveMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">MetalnessMap:</span>
        <input type="checkbox" id="metalnessMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">RoughnessMap:</span>
        <input type="checkbox" id="roughnessMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">DisplacementMap:</span>
        <input type="checkbox" id="displacementMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">AOMap:</span>
        <input type="checkbox" id="aoMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">AlphaMap:</span>
        <input type="checkbox" id="alphaMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">LightMap:</span>
        <input type="checkbox" id="lightMap" class="form-control pull-right material-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">NormalMap:</span>
        <input type="checkbox" id="normalMap" class="form-control pull-right material-checkbox">
    </h4>

</div>

<script>

(function(){

    const textureHeaderSelector = ".texture-header";
    const helpersHeaderSelector = ".helpers-header";
    const textureControlSelector = "#material-texture-controls";

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(textureHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( $(textureControlSelector).get(0) );
    });

})();

</script>

<div style="margin-bottom:10px;">
    <div id="save-material-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:74%;">Save</div>
    <div id="reset-material-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:24%;">Reset</div>
</div>

<script>

(function(){

    var files = {};
    var textures = {};

    const viewer = document.getElementById("viewer");
    const propControls = document.getElementById("material-property-controls");
    const genderDroplist = document.getElementById("material-gender-droplist");
    const slotDroplist = $("select#outifit-slot").get(0);
    const typeDroplist = $("select#material-type").get(0);
    const propDroplist = $("select#material-property").get(0);
    const titleTextfield = $("input#material-title").get(0);

    const textureImportBtn = $("#import-texture-button").get(0);
    const textureFileinput = $("input#texture-fileinput").get(0);
    const textureDroplist  = $("select#imported-textures").get(0);
    const textureCheckboxSelector = "input[type=checkbox].form-control.pull-right.material-checkbox";

    var Signal = signals.Signal;
    var propertyValueChanged = new Signal();

    propertyValueChanged.add( function(key, value){

        if ( key == undefined ) return;
        if ( !$(slotDroplist).val() ) return;
        if ( !$(genderDroplist).val() ) return;

        var data = {};

        data.key    = key;
        data.value  = value;
        data.slot   = $(slotDroplist).val();
        data.gender = $(genderDroplist).val();

        viewer.contentWindow.localPlayerMaterialHandler(data);

    });

    initMaterialPropertiesDroplist();

    function newJsonTexture() {
        return {
            anisotropy: 1,
            encoding: 3000,
            flipY: true,
            format: 1021,
            generateMipmaps: true,
            magFilter: 1006,
            mapping: 300,
            minFilter: 1008,
            mipmaps: [],
            name: "",
            offset: [0, 0],
            premultiplyAlpha: false,
            repeat: [1, 1],
            sourceFile: "",
            type: 1009,
            unpackAlignment: 4,
            uuid: THREE.Math.generateUUID(),
            version: 0,
            wrapS: 1001,
            wrapT: 1001,
            _id: ObjectId(),
        };
    }

    function updateMaterialPropertiesDroplist(){

        $(titleTextfield).val("");

    //  var TYPE = $(typeDroplist).val();
    //  var material = new THREE[ TYPE ]();
    //  var json = materialtoJSON(material);

        var json = newJsonTexture();

        $(propDroplist).off();
        $(propDroplist).children().remove();
        $(propControls).children().remove();

        for ( var key in json ) {

            if ( key == undefined ) return;

            var option = document.createElement("option");
            option.id = key; option.value = json[ key ]; option.innerText = key;

            $(propDroplist).append(option);

        }

        $(propDroplist).on("change", function(){

            $(propControls).css({height:""});
            $(propControls).children().remove();
            var key = $(this.selectedOptions[0]).text();

            switch (key) {

                case "color":
                case "emissive":

                    (function(){

                        var input = document.createElement("input");
                        input.type = "hidden"; input.id = "input_" + key;

                        $(propControls).append(input);
                        $(propControls).css({height:"auto"});

                        $(input).spectrum({

                            preferredFormat: "hex",
                            color: "#ffffff",
                            flat: true,
                            showInput: true,
                            showInitial: true,
                            showButtons: false,
                            allowEmpty: false,

                            move: function(color) {
                                var hex = color.toString("hex").replace(/#/, "0x");
                                json[ key ] = Number(hex); // important!
                                propertyValueChanged.dispatch(key, hex);
                                $(propDroplist).find(`option#${key}`).val( json[key] );
                            },

                        });

                    //  Colorpicker startup.

                        var hexString = "#" + json[ key ].toString(16);
                        $("#sp-scene-background").spectrum( "set", hexString );

                    })();

                break;

                case "_id":

                    (function(){

                        var button = document.createElement("div");
                        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
                        button.id = "button_id"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

                        var input = document.createElement("input");
                        input.id = "input_id"; input.type = "text";
                        input.classList.add("form-control", "text-center", "pull-right", "uuid-material-textfield");

                        if (json._id) input.value = json._id;
                        else input.value = json._id = ObjectId();

                        $(button).on("click", function(){
                            var objectId = ObjectId();
                            input.value = json._id = objectId;
                            $(propDroplist).find("option#_id").val( objectId );
                        });

                        $(input).on("input", function(){
                            json._id = this.value;
                            $(propDroplist).find("option#_id").val( this.value );
                        });

                        $(propControls).append(button, input);

                    })();

                break;

                case "uuid":

                    (function(){

                        var button = document.createElement("div");
                        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
                        button.id = "button_uuid"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

                        var input = document.createElement("input");
                        input.id = "input_uuid"; input.type = "text"; input.readOnly = true;
                        input.classList.add("form-control", "pull-right", "uuid-material-textfield");

                        if (json.uuid) input.value = json.uuid;
                        else input.value = json.uuid = THREE.Math.generateUUID();

                        $(button).on("click", function(){
                            var uuid = THREE.Math.generateUUID();
                            input.value = json.uuid = uuid;
                            $(propDroplist).find("option#uuid").val( uuid );
                        });

                        $(input).on("input", function(){
                            json.uuid = this.value;
                            $(propDroplist).find("option#uuid").val( this.value );
                        });

                        $(propControls).append(button, input);

                    })();

                break;

                case "name":
                    
                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "name"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_name"; input.type = "text";
                        input.classList.add("form-control", "pull-right", "material-textfield");

                        titleTextfield.value = input.value = json.name;

                        $(input).on("input", function(){
                            titleTextfield.value = json.name = this.value;
                            $(propDroplist).find("option#name").val( this.value );
                        });

                        $(propControls).append(span, input);

                    })();

                break;

                case "bumpScale":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "bumpScale"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_bumpScale"; input.type = "number"; input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.bumpScale;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.bumpScale = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#bumpScale").val( value );
                        });

                        $(propControls).append(span, input);

                    })();

                break;

                case "normalScale":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "normalScale"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_normalScale"; input.type = "number"; input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        if ( json.normalScale && typeof(json.normalScale) == "array" ) {
                            input.value = json.normalScale[0];
                        }

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            propertyValueChanged.dispatch(key, value );
                            json.normalScale[0] = json.normalScale[1] = value;
                            $(propDroplist).find("option#normalScale").val( value );
                        });

                        $(propControls).append(span, input);

                    })();

                break;

                case "opacity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "opacity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_opacity"; input.type = "number"; 
                        input.step = 0.01; input.min = 0; input.max = 1;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.opacity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.opacity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#opacity").val( value );
                        });

                        $(propControls).append(span, input);

                    })();

                break;










            }

        });

        $(propDroplist).change();

    }

    function initMaterialPropertiesDroplist(){

        $(slotDroplist).on("change", function(){
            updateMaterialPropertiesDroplist();
        });

        $(typeDroplist).on("change", function(){
            updateMaterialPropertiesDroplist();
        });

        updateMaterialPropertiesDroplist();

    }


//  TEXTURES.

    $(textureDroplist).on("change", function(){
        $(textureCheckboxSelector).attr({checked:false});
    });

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){

        if ( this.files.length == 0 ) return;

        var file = this.files[0];
        var name = this.files[0].name;

        if ( name in files && file.lastModified == files[name].lastModified 
            && file.size == files[name].size && file.type == files[name].type ) {

                                /* (DO WHATEVER) */

        } else {

            files[ name ] = file;

            var reader = new FileReader();
            reader.onload = function() {

                textures[ name ] = newJsonTexture();
                textures[ name ].sourceFile = reader.result;
                textures[ name ].name = name;

                var option = document.createElement("option");
                option.value = option.innerText = name;
                option.id = textures[ name ]._id;

                $(textureDroplist).append(option);
                textureDroplist.value = name;
                $(textureCheckboxSelector).attr({checked:false});

            };

            reader.readAsDataURL(files[ name ]);

        }

    });

    var maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
        "aoMap", 
        "envMap",
    ];

    maps.forEach(function(map){
        $(`input[type=checkbox]#${map}`).on("click", function(){
            if (!textureDroplist.value) return;
            var name = textureDroplist.value;
            if ( this.checked )
                var texture = textures[name];
            else
                var texture = null;
            propertyValueChanged.dispatch( map, texture );
        });
    });



//  SAVE.

    $("#reset-material-button").on("click", function(){
        initMaterialPropertiesDroplist();
    });

    $("#save-material-button").on("click", function(){
        debugMode && console.log({"save":"TODO"});
    });

})();


