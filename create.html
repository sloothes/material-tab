<script>

    $(function(){
        var component_ID = {
            type: "tab",
            demo: true,
            version: 1.6,
            kind: "component",
            name: "create-material-tab.html",
            description: "creates outfit material in zangoDB.",
        };
    });

</script>

<style>

    .selected {
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 142, 255, 1);
    }

    #material-title {
        color:#ffffff;
        background:none;
    }

    .material-value {
        text-align: center;
        font-size: x-large;
        font-weight: bold;
    }
    
    .material-textfield {
        width:70%;
        float:right;
    }

    .x-large {
        font-size: x-large;
    }
    
    .material-property-controls {
        height:72px;
    }

    .material-textfield {
        width:75%;
    }

    .uuid-material-textfield {
        width:80%;
    }

    .material-checkbox {
        width:34px;
    }

    .texture-checkbox {
        height:40px;
        margin-top:0px;
        margin-bottom:0px;
    }

    .material-input-number {
        width: 60px;
        padding: 0;
        text-align: right;
        background: none;
        font-weight: bold;
        font-size: 18px;
        border: none;
        color: #ffff;
    }

    .helpers-header h2 { 
        cursor:pointer; 
    }

    #material-property-controls {
        background:none;
        border-radius:8px;
        height:73px;
    }

    .catalog-item {
        width:85px;
        height:85px;
        margin:4px;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }
    
    .sp-container {
        width:100%;
    }

    .sp-picker-container {
        width:93%;
    }


</style>

<div class="helpers-header material-header">
    <h2 style="margin-bottom:20px;">Material:</h2>
</div>

<div style="margin-bottom:20px;">
    <input type="text" id="material-title" class="form-control text-center x-large material-title-field" placeholder="new untitled material">
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select gender:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-gender-droplist" class="form-control gender droplist" readonly>
                <option value="">Select sex:</option>
                <option value="male">male</option>
                <option value="female">female</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const droplist = document.getElementById("material-gender-droplist");
    const outfitHelpersTabSelector = ".outfit-helpers.component-pane.tab-pane";

    var Signal = signals.Signal;
    var genderChanged = new Signal();

    genderChanged.add(function(value){
        if ( !value ) return;

        var data = "/gender/" + value;
        viewer.contentWindow.localPlayerHandler(data);
        store( "Sex", data );

    });

    $(droplist).on("change", function(){
        if ( !this.value ) return;
        genderChanged.dispatch( this.value );
    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select outfit slot:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="outfit-slot" class="form-control outfit-slot-droplist" readonly>
                <option value="">Select slot:</option>
                <option value="body">body</option>
                <option value="eyes">eyes</option>
                <option value="hairs">hairs</option>
                <option value="stockings">stockings</option>
                <option value="underwears">underwears</option>
                <option value="costume">costume</option>
                <option value="tshirt">tshirt</option>
                <option value="trousers">trousers</option>
                <option value="dress">dress</option>
                <option value="shoes">shoes</option>
            </select>
        </div>
    </h4>
</div>

<script>

(function(){

    const viewer = document.getElementById("viewer");
    const droplist = $("select#outfit-slot").get(0);

    var Signal = signals.Signal;
    var outfitSlotChanged = new Signal();

    outfitSlotChanged.add(function(value){
        var data = "/select/" + value;
        viewer.contentWindow.localPlayerHandler(data);
    });

    $(droplist).on("change", function(){
        outfitSlotChanged.dispatch(this.value);
    });

})();

</script>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select material type:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-type" class="form-control material-type-droplist" readonly>
                <option value="MeshStandardMaterial">standard</option>
                <option value="MeshPhongMaterial">phong</option>
                <option value="MeshLambertMaterial">lambert</option>
                <option value="MeshBasicMaterial">basic</option>
            </select>
        </div>
    </h4>
</div>

<div style="height:35px;margin-bottom:10px;">
    <h4><span style="vertical-align:-0.5rem;">Select property:</span>
        <div style="width:40%;display:inline-block;float:right;">
            <select id="material-property" class="form-control material-property-droplist" readonly>
                <option value="">Select key:</option>
            </select>
        </div>
    </h4>
</div>

<div id="material-property-controls" class="well"></div>

<div style="margin-bottom:10px;">
    <div id="save-material-button" class="form-control btn btn-success btn-white-outline gradient-btn pull-left" style="width:24%;">Save</div>
    <div id="apply-material-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:50%;margin:0 1%;">Apply</div>
    <div id="reset-material-button" class="form-control btn btn-danger btn-white-outline gradient-btn pull-right" style="width:24%;">Reset</div>
</div>

<script>

(function(){

    const materialHeaderSelector = ".material-header";
    const helpersHeaderSelector = ".helpers-header";
    const materialControlSelector = "#material-property-controls";

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(materialHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( $(materialControlSelector).get(0) );
    });

})();

</script>

<div class="helpers-header texture-header">
    <h2 style="margin-bottom:20px;">Textures:</h2>
</div>

<div style="height:45px;margin-bottom:20px;">
    <select id="imported-textures" class="form-control material-texture-droplist" readonly>
        <option value="">Select imported texture:</option>
    </select>
</div>

<div id="material-texture-controls" class="well" style="background:none;border-radius:8px;height:auto;display:none;">

    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">Map:</span>
        <input type="checkbox" id="map" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">BumpMap:</span>
        <input type="checkbox" id="bumpMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">EmissiveMap:</span>
        <input type="checkbox" id="emissiveMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">MetalnessMap:</span>
        <input type="checkbox" id="metalnessMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">RoughnessMap:</span>
        <input type="checkbox" id="roughnessMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">DisplacementMap:</span>
        <input type="checkbox" id="displacementMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">AOMap:</span>
        <input type="checkbox" id="aoMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">AlphaMap:</span>
        <input type="checkbox" id="alphaMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">LightMap:</span>
        <input type="checkbox" id="lightMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>
    <h4 class="texture-checkbox">
        <span style="vertical-align:-0.7rem;">NormalMap:</span>
        <input type="checkbox" id="normalMap" class="form-control pull-right material-checkbox material-texture-checkbox">
    </h4>

</div>

<div style="margin-bottom:20px;">
    <input id="texture-fileinput" type="file" class="hidden" multiple>
    <div id="import-texture-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:74%;">Import textures</div>
    <div id="clear-import-textures" class="form-control btn btn-danger btn-white-outline gradient-btn pull-right" style="width:24%;">Clear</div>
</div>

<script>

(function(){

    const textureHeaderSelector = ".texture-header";
    const helpersHeaderSelector = ".helpers-header";
    const textureControlSelector = "#material-texture-controls";

    var Signal = signals.Signal;
    var dblclicked = new Signal();

//  Event handlers.
    function onDoubleClickEventHandler( element ){
        if ( $(element).css("display") == "none" ) {
            $(element).slideDown();
        } else {
            $(element).slideUp();
        }
    }

//  Event listeners.
    dblclicked.add(onDoubleClickEventHandler);

//  Dispatch events.
    $(textureHeaderSelector).on("dblclick", function(){
        dblclicked.dispatch( $(textureControlSelector).get(0) );
    });

})();

</script>


<script>

loadjs(["/three/three.js", "/material/materialtoJson.js"], function(){

    var files = {};
    var uploads = [];
    var textures = {};

    const viewer = document.getElementById("viewer");
    const propControls = document.getElementById("material-property-controls");
    const genderDroplist = document.getElementById("material-gender-droplist");
    const slotDroplist = $("select#outfit-slot").get(0);
    const typeDroplist = $("select#material-type").get(0);
    const propDroplist = $("select#material-property").get(0);
    const titleTextfield = $("input#material-title").get(0);
    const textureImportBtn = $("#import-texture-button").get(0);
    const textureFileinput = $("input#texture-fileinput").get(0);
    const texturesClearBtn = $("#clear-import-textures").get(0);
    const textureDroplist  = $("select#imported-textures").get(0);
    const textureControlSelector = "#material-texture-controls";
    const textureCheckboxSelector = "input[type=checkbox].material-texture-checkbox";

    var Signal = signals.Signal;
    var propertyValueChanged = new Signal();
    var outfitMaterialChanged = new Signal();

    var json = materialtoJSON( new THREE.Material() );
    debugMode && console.log({"json": json});

    $(titleTextfield).on("input", function(){
        json.name = this.value;
        $("input[type=text]#input_name").val(this.value);
    });

    outfitMaterialChanged.add(function(json){

        if ( !$(slotDroplist).val() ) return;
        if ( !$(genderDroplist).val() ) return;

        var data = {
            slot: $(slotDroplist).val(),
            gender: $(genderDroplist).val(),
            material: json,
        };

        viewer.contentWindow.localPlayerApplyMaterial(data);

    });

    propertyValueChanged.add( function(key, value){

        if ( key == undefined ) return;
        if ( !$(slotDroplist).val() ) return;
        if ( !$(genderDroplist).val() ) return;

        var data = {};

        var slot = $(slotDroplist).val();
        var gender = $(genderDroplist).val();

        data.key    = key;
        data.value  = value;
        data.slot   = slot;
        data.gender = gender;

        switch( key ) {

            case "map":
            case "alphaMap":
                viewer.contentWindow.localPlayerMaterialHandler(data);
            break;

            case "bumpMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "bumpScale",
                    value: json.bumpScale,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "emissiveMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "emissive",
                    value: json.emissive,
                    slot: slot,
                    gender: gender,
                }, {
                    key: "emissiveIntensity",
                    value: json.emissiveIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "displacementMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "displacementBias",
                    value: json.displacementBias,
                    slot: slot,
                    gender: gender,
                }, {
                    key: "displacementScale",
                    value: json.displacementScale,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "lightMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "lightMapIntensity",
                    value: json.lightMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "metalnessMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "metalness",
                    value: json.metalness,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "roughnessMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "roughness",
                    value: json.roughness,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "normalMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "normalScale",
                    value: json.normalScale[0],
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "aoMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "aoMapIntensity",
                    value: json.aoMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            case "envMap":
                viewer.contentWindow.localPlayerMaterialHandler({
                    key: "envMapIntensity",
                    value: json.envMapIntensity,
                    slot: slot,
                    gender: gender,
                }, {
                    key: key,
                    value: value,
                    slot: slot,
                    gender: gender,
                });
            break;

            default:
                viewer.contentWindow.localPlayerMaterialHandler(data);
            break;
        }

    });

    function newJsonTexture() {
        return {
            anisotropy: 1,
            encoding: 3000,
            flipY: true,
            format: 1021,
            generateMipmaps: true,
            magFilter: 1006,
            mapping: 300,
            minFilter: 1008,
            mipmaps: [],
            name: "",
            offset: [0, 0],
            premultiplyAlpha: false,
            repeat: [1, 1],
            sourceFile: "",
            type: 1009,
            unpackAlignment: 4,
            uuid: THREE.Math.generateUUID(),
            version: 0,
            wrapS: 1001,
            wrapT: 1001,
            _id: ObjectId(),
        };
    }

    function updateMaterialPropertiesDroplist(){

        $(titleTextfield).val("");

        var TYPE = $(typeDroplist).val();
        var material = new THREE[ TYPE ]();
        json = materialtoJSON(material);

        json._id = ObjectId();  //  important!
    //  json.uuid = THREE.Math.generateUUID();

    //  Settings.
        json.skinning = true;
        json.bumpScale = 0.05;
        json.depthTest = true;
        json.depthWrite = true;
        json.displacementBias = 0;
        json.displacementScale = 0;
        json.normalScale = [0.1, 0.1];
        json.color = Number(0xffffff);
        json.emissive = Number(0x000000);

        $(propDroplist).off();
        $(propDroplist).children().remove();
        $(propControls).children().remove();

    //  Sort json keys.
        var sortedKeys = Object.keys(json).sort();
        for ( var i = 0; i < sortedKeys.length; i++ ) {

            var key = sortedKeys[i];
            var option = document.createElement("option");

            option.id = key; 
            option.innerText = key;

            switch (key) {

                case "normalScale":

                    if ( typeof(json[key]) == "number" ) {
                        option.value = json[ key ]; break;
                    }

                //  leading value is the "normalScale.x"

                    if (Array.isArray(json[key]) && json[key].length) {
                        option.value = json[key][0]; break;
                    }

                break;

                default:
                    if ( typeof(json[key]) != "boolean" ) {
                        option.value = json[ key ]; break;
                    } else {
                        option.value = json[key] || ""; break;
                    }
                break;

            }

            $(propDroplist).append(option);

        }

        $(propDroplist).on("change", function(){

            $(propControls).css({height:""});
            $(propControls).children().remove();
            var key = $(this.selectedOptions[0]).text();

            switch (key) {

                case "color":

                    (function(){

                        var input = document.createElement("input");
                        input.type = "hidden"; input.id = "input_color";

                        $(propControls).append(input);
                        $(propControls).css({height:"auto"});

                        $(input).spectrum({

                            preferredFormat: "hex",
                            color: "#ffffff",
                            flat: true,
                            showInput: true,
                            showInitial: true,
                            showButtons: false,
                            allowEmpty: false,

                            move: function(color) {
                                var hex = color.toString("hex").replace(/#/, "0x");
                                json.color = Number(hex);
                                propertyValueChanged.dispatch(key, hex);
                                $(propDroplist).find("option#color").val( json.color );
                            },

                        });

                    //  Colorpicker startup.

                        var hexString = "#" + json.color.toString(16);
                        $("#sp-scene-background").spectrum( "set", hexString );

                        $(propControls).slideDown();

                    })();

                break;

                case "emissive":

                    (function(){

                        var input = document.createElement("input");
                        input.type = "hidden"; input.id = "input_emissive";

                        $(propControls).append(input);
                        $(propControls).css({height:"auto"});

                        $(input).spectrum({

                            preferredFormat: "hex",
                            color: "#000000",
                            flat: true,
                            showInput: true,
                            showInitial: true,
                            showButtons: false,
                            allowEmpty: false,

                            move: function(color) {
                                var hex = color.toString("hex").replace(/#/, "0x");
                                json.emissive = Number(hex);
                                propertyValueChanged.dispatch(key, hex);
                                $(propDroplist).find("option#emissive").val( json.emissive );
                            },

                        });

                    //  Colorpicker startup.

                        var hexString = "#" + json.emissive.toString(16);
                        $("#sp-scene-background").spectrum( "set", hexString );

                        $(propControls).slideDown();

                    })();

                break;

                case "_id":

                    (function(){

                        var button = document.createElement("div");
                        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
                        button.id = "button_id"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

                        var input = document.createElement("input");
                        input.id = "input_id"; input.type = "text"; input.readOnly = true;
                        input.classList.add("form-control", "text-center", "pull-right", "uuid-material-textfield");

                        if (json._id) input.value = json._id;
                        else input.value = json._id = ObjectId();
                        $(propDroplist).find("option#_id").val( json._id );

                        $(button).on("click", function(){
                            var objectId = ObjectId();
                            input.value = json._id = objectId;
                            $(propDroplist).find("option#_id").val( objectId );
                        //  Change uuid also.
                            var uuid = json.uuid = THREE.Math.generateUUID();
                            $(propDroplist).find("option#uuid").val( uuid );
                        });

                        $(input).on("input", function(){
                            json._id = this.value;
                            $(propDroplist).find("option#_id").val( this.value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(button, input);

                    })();

                break;

                case "uuid":

                    (function(){

                        var button = document.createElement("div");
                        button.classList.add("form-control", "btn", "btn-info", "btn-white-outline", "gradient-btn");
                        button.id = "button_uuid"; button.innerText = "⟳"; button.style.cssText = "width:fit-content;";

                        var input = document.createElement("input");
                        input.id = "input_uuid"; input.type = "text"; input.readOnly = true;
                        input.classList.add("form-control", "pull-right", "uuid-material-textfield");

                        if (json.uuid) input.value = json.uuid;
                        else input.value = json.uuid = THREE.Math.generateUUID();
                        $(propDroplist).find("option#uuid").val( json.uuid );

                        $(button).on("click", function(){
                            var uuid = THREE.Math.generateUUID();
                            input.value = json.uuid = uuid;
                            $(propDroplist).find("option#uuid").val( uuid );
                        //  Change _id also.
                            var objectId = json._id = ObjectId();
                            $(propDroplist).find("option#_id").val( objectId );
                        });

                        $(input).on("input", function(){
                            json.uuid = this.value;
                            $(propDroplist).find("option#uuid").val( this.value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(button, input);

                    })();

                break;

                case "name":
                    
                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "name"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_name"; input.type = "text";
                        input.classList.add("form-control", "pull-right", "material-textfield");

                        titleTextfield.value = input.value = json.name;

                        $(input).on("input", function(){
                            titleTextfield.value = json.name = this.value;
                            $(propDroplist).find("option#name").val( this.value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "type":
                    
                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "type"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_type"; input.type = "text"; input.readOnly = true;
                        input.classList.add("form-control", "pull-right", "material-textfield");

                        input.value = json.type;

                        $(propControls).append(span, input);

                    })();

                break;

                case "bumpScale":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "bumpScale"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_bumpScale"; input.type = "number"; input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.bumpScale;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.bumpScale = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#bumpScale").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "displacementScale":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "displacementScale"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_displacementScale"; input.type = "number"; input.step = 0.01;

                        input.value = json.displacementScale;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.displacementScale = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#displacementScale").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "displacementBias":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "displacementBias"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_displacementBias"; input.type = "number"; input.step = 0.01;

                        input.value = json.displacementBias;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.displacementBias = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#displacementBias").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "normalScale":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "normalScale"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_normalScale"; input.type = "number"; input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        if ( json.normalScale && Array.isArray(json.normalScale) ) {
                            input.value = json.normalScale[0];
                        }

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            propertyValueChanged.dispatch(key, value );
                            json.normalScale[0] = json.normalScale[1] = value;
                            $(propDroplist).find("option#normalScale").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "visible":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "visible"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_visible"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.visible || "";

                        $(input).on("click", function(){
                            json.visible = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#visible").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "opacity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "opacity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_opacity"; input.type = "number"; 
                        input.step = 0.01; input.min = 0; input.max = 1;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.opacity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.opacity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#opacity").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "transparent":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "transparent"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_transparent"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.transparent || "";

                        $(input).on("click", function(){
                            json.transparent = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#transparent").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "skinning":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "skinning"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_skinning"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.skinning || "";

                        $(input).on("click", function(){
                            json.skinning = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#skinning").val( this.checked || "" );
                        });

                        $(propControls).append(span, input);

                    })();

                break;

                case "wireframe":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "wireframe"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_wireframe"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.wireframe || "";

                        $(input).on("click", function(){
                            json.wireframe = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#wireframe").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "fog":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "fog"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_fog"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.fog || "";

                        $(input).on("click", function(){
                            json.fog = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#fog").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "lights":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "lights"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_lights"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.lights || "";

                        $(input).on("click", function(){
                            json.lights = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#lights").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "emissiveIntensity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "emissiveIntensity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_emissiveIntensity"; input.type = "number";  input.step = 0.01;

                        input.value = json.emissiveIntensity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.emissiveIntensity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#emissiveIntensity").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "lightMapIntensity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "lightMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_lightMapIntensity"; input.type = "number";  input.step = 0.01;

                        input.value = json.lightMapIntensity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.lightMapIntensity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#lightMapIntensity").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "aoMapIntensity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "aoMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_aoMapIntensity"; input.type = "number";  input.step = 0.01;

                        input.value = json.aoMapIntensity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.aoMapIntensity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#aoMapIntensity").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "colorWrite":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "colorWrite"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_colorWrite"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.colorWrite || "";

                        $(input).on("click", function(){
                            json.colorWrite = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#colorWrite").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "clipShadows":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "clipShadows"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_clipShadows"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.clipShadows || "";

                        $(input).on("click", function(){
                            json.clipShadows = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#clipShadows").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;
            /*
                case "alphaTest":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "alphaTest"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_alphaTest"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = Boolean(json.alphaTest) || "";

                        $(input).on("click", function(){
                            var value = Number(this.checked);
                            json.alphaTest = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#alphaTest").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;
            */
                case "depthTest":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "depthTest"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_depthTest"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.depthTest || "";

                        $(input).on("click", function(){
                            json.depthTest = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#depthTest").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "depthWrite":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "depthWrite"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_depthWrite"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.depthWrite || "";

                        $(input).on("click", function(){
                            json.depthWrite = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#depthTest").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "depthFunc":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "depthFunc"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.min = 0; input.max = 7; input.step = 1;
                        input.id = "input_depthFunc"; input.type = "number";  
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.depthFunc;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.depthFunc = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#depthFunc").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "morphNormals":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "morphNormals"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_morphNormals"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.morphNormals || "";

                        $(input).on("click", function(){
                            json.morphNormals = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#morphNormals").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "morphTargets":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "morphTargets"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_morphTargets"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.morphTargets || "";

                        $(input).on("click", function(){
                            json.morphTargets = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#morphTargets").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "refractionRatio":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "refractionRatio"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_refractionRatio"; input.type = "number";  input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.refractionRatio;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.refractionRatio = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#shading").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "metalness":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "metalness"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_metalness"; input.type = "number";  input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.metalness;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.metalness = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#metalness").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "roughness":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "roughness"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_roughness"; input.type = "number";  input.step = 0.01;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.roughness;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.roughness = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#roughness").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "shading":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "shading"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_shading"; input.type = "number"; 
                        input.step = 1; input.min = 1; input.max = 2;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.shading;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.shading = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#shading").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "side":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "side"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_side"; input.type = "number"; 
                        input.step = 1; input.min = 0; input.max = 2;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.side;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.side = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#side").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "wireframeLinewidth":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "wireframeLinewidth"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.id = "input_wireframeLinewidth"; 
                        input.type = "number"; input.step = 1; input.min = 1;
                        input.classList.add("form-control", "pull-right", "material-input-number");

                        input.value = json.wireframeLinewidth;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.wireframeLinewidth = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#wireframeLinewidth").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "wireframeLinecap":
                    
                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "wireframeLinecap"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_wireframeLinecap"; input.type = "text"; 
                        input.style.cssText = "width:40%;"; input.readOnly = true;
                        input.classList.add("form-control", "pull-right", "material-textfield"); 

                        input.value = json.wireframeLinecap;

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "wireframeLinejoin":
                    
                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "wireframeLinejoin"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_wireframeLinejoin"; input.type = "text"; 
                        input.style.cssText = "width:40%;"; input.readOnly = true;
                        input.classList.add("form-control", "pull-right", "material-textfield"); 

                        input.value = json.wireframeLinejoin;

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "polygonOffset":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "polygonOffset"; span.style.cssText = "vertical-align:-0.7rem;";

                        var input = document.createElement("input"); 
                        input.id = "input_polygonOffset"; input.type = "checkbox"; 
                        input.classList.add("form-control", "pull-right", "material-checkbox");

                        input.checked = json.polygonOffset || "";

                        $(input).on("click", function(){
                            json.polygonOffset = this.checked;
                            propertyValueChanged.dispatch(key, this.checked);
                            $(propDroplist).find("option#polygonOffset").val( this.checked || "" );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "polygonOffsetFactor":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "polygonOffsetFactor"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_polygonOffsetFactor"; input.type = "number"; input.step = 1;

                        input.value = json.polygonOffsetFactor;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.polygonOffsetFactor = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#side").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "polygonOffsetUnits":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "polygonOffsetUnits"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_polygonOffsetUnits"; input.type = "number"; input.step = 1;

                        input.value = json.polygonOffsetUnits;

                        $(input).on("input", function(){
                            var value = parseInt(this.value);
                            json.polygonOffsetUnits = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#side").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

                case "envMapIntensity":

                    (function(){

                        var span = document.createElement("span");
                        span.innerText = "envMapIntensity"; span.style.cssText = "vertical-align:-0.7rem;";
                        
                        var input = document.createElement("input"); 
                        input.classList.add("form-control", "pull-right", "material-input-number");
                        input.id = "input_envMapIntensity"; input.type = "number";  input.step = 0.01;

                        input.value = json.envMapIntensity;

                        $(input).on("input", function(){
                            var value = round(this.value, 2);
                            json.envMapIntensity = value;
                            propertyValueChanged.dispatch(key, value);
                            $(propDroplist).find("option#envMapIntensity").val( value );
                        });

                        $(propControls).slideDown();
                        $(propControls).append(span, input);

                    })();

                break;

            }

        });

        $(propDroplist).change();

    }

/*
//  initMaterialPropertiesDroplist();

    function initMaterialPropertiesDroplist(){
        $(slotDroplist).off();
        $(typeDroplist).off();

        $(slotDroplist).on("change", function(){
            updateMaterialPropertiesDroplist();
        });

        $(typeDroplist).on("change", function(){
            updateMaterialPropertiesDroplist();
        });

        updateMaterialPropertiesDroplist();

    }
*/

    $(slotDroplist).on("change", function(){
        updateMaterialPropertiesDroplist();
    });

    $(typeDroplist).on("change", function(){
        updateMaterialPropertiesDroplist();
    });

    updateMaterialPropertiesDroplist();


//  TEXTURES.

    var maps = [
        "map", 
        "bumpMap", 
        "emissiveMap", 
        "metalnessMap", 
        "roughnessMap", 
        "displacementMap", 
        "alphaMap", 
        "normalMap", 
        "lightMap", 
        "aoMap", 
        "envMap",
    ];

    maps.forEach(function(mapkey){
        $(`input[type=checkbox]#${mapkey}`).on("click", function(){

            if (!textureDroplist.value) return;
            var name = textureDroplist.value;

            if ( this.checked ) {
                var texture = textures[name];
                json[ mapkey ] = textures[name];
            } else {
                var texture = null;
                delete json[ mapkey ];
            }

            propertyValueChanged.dispatch( mapkey, texture );
        });
    });

    $(textureDroplist).on("change", function(){

        $(textureCheckboxSelector).attr({checked:false});

        if ( this.value ) {
            $(textureControlSelector).slideDown();
        } else {
            $(textureControlSelector).slideUp();
        }

    });

    $(textureImportBtn).on("click", function(){
        $(textureFileinput).val("");
        $(textureFileinput).click();
    });

    $(textureFileinput).on("change", function(){

        if ( this.files.length == 0 ) return;

        for (var i = 0; i < this.files.length; i++ ) {

            (() => {

                var file = this.files[i];
                var name = this.files[i].name;

                if ( name in files && file.lastModified == files[name].lastModified 
                    && file.size == files[name].size && file.type == files[name].type ) {

                        /* (WHATEVER) */

                } else {

                    files[ name ] = file;

                    var reader = new FileReader();
                    reader.onload = function() {

                        textures[ name ] = newJsonTexture();
                        textures[ name ].sourceFile = reader.result;
                        textures[ name ].name = name;

                        var option = document.createElement("option");
                        option.value = option.innerText = name;
                        option.id = textures[ name ]._id;

                        $(textureDroplist).append(option);
                    //  textureDroplist.value = name;
                        $(textureCheckboxSelector).attr({checked:false});

                    };

                    reader.readAsDataURL(files[ name ]);

                }

            })();

        }

    });


//  CLEAR.

    $(texturesClearBtn).on("click", function(){

    //  files = {}; textures = {}; // optional!
        $(textureDroplist).children().remove();
        var option = document.createElement("option");
        option.value = ""; option.innerText = "Select imported texture:";
        $(textureDroplist).append(option);
        $(textureControlSelector).slideUp();

    });


//  SAVE.

    $("#apply-material-button").on("click", function(){
        outfitMaterialChanged.dispatch(json);
    });

    $("#reset-material-button").on("click", function(){
    //  initMaterialPropertiesDroplist();
        updateMaterialPropertiesDroplist();
    });

    $("#save-material-button").on("click", async function(){

        if ( !json._id ) json._id = ObjectId();  
        //  throw `Material "_id" required.`;
        if ( !json.uuid ) json.uuid = THREE.Math.generateUUID();  
        //  throw `Material "uuid" required.`;

        if ( !json.name ) {
            json.name = await new Promise(function(resolve, reject){
                var title = `<div class="alert-icon icon-warning"></div>`
                + `<h2 style="margin:auto;">Name required</h2>`
                + `<div>Please type a name for this material</div>`
                bootbox.prompt({
                    size: "small",
                    title: title,
                    className: "middle",
                    callback: function(name){
                        if ( name ) {
                            resolve(name);
                        } else {
                        //  if null, dialog does not close!
                            reject( `Material name is required.` );
                        }
                    },
                });
            }).catch(function(err){
                bootbox.dialog({
                    size: "small",
                    className: "middle",
                    title: `<div class="alert-icon icon-warning"></div>`
                         + `<h2 style="margin:auto;">Canceled!</h2>`,
                    message: `<div>Save canceled!</div>`
                           + `<div>${err}</div>`,
                    buttons: {
                        cancel: {
                            label: 'Close',
                            className: 'btn-default',
                        },
                    },
                });
            //  escape from save proccess.
                throw err;  //  important!
            });
        }

        $("option#name").val( json.name );   // optional!
        $(titleTextfield).val( json.name );  // optional!


    //  Material metadata.

        json.meta = {};

        json.meta.slot = slotDroplist.value;
        json.meta.gender = genderDroplist.value;

        debugMode && console.log({"json":json});


    //  Validate json.

        if ( "validator" in window ) {
            var isValid = await (async function(){
                var str = JSON.stringify( json );
                return validator.isJSON(str);
            })();
            if (!isValid) throw "json is not valid";
        }


    //  Insert to collection.

        var collection = UserDB.collection("materials");

        await collection.insert(json, function(err){
            if (err) throw err;
        }).catch(function(err){
            console.error(err);
        //  Error.
            bootbox.dialog({
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-error"></div>`
                     + `<h2 style="margin:auto;">Error!</h2>`,
                message: `<div>Sorry! An error occurred.</div>`
                       + `<div>${err}</div>`,
                buttons: {
                    cancel: {
                        label: 'Close',
                        className: 'btn-default',
                    },
                },
            });
        //  escape from save proccess.
            throw err;  //  important!
        });


    //  Upload texture images (in background).

        var selector = {_id:json._id};

        await collection.findOne(selector, function(err){
            if (err) throw err;
        }).then(function(doc){

            if (!doc) throw "material could not be found!";

        //  Success.
            bootbox.dialog({
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-success"></div>`
                     + `<h2 style="margin:auto;">Success</h2>`,
                message: `<div>Material ${json.name} has been saved!</div>`,
                buttons: {
                    success: {
                        label: 'Close',
                        className: 'btn-success',
                        callback: function(){ 
                            updateMaterialPropertiesDroplist();
                        },
                    },
                },
            });

            return doc;

        }).then(function(doc){

            var textureImages = {};

        //  Filter duplicate textures.

            var textureMaps = maps.filter(function(map){
                return ( doc[ map ] != undefined );
            });

            debugMode && console.log("textureMaps:", textureMaps);

        //  First pass (collect data).

            textureMaps.forEach(function( key ){
                if ( !doc[ key ] ) return;
                var texture = doc[ key ];
            //  It is a "fake" texture, not real one.
                if ( texture.sourceFile && texture.name ) {
                    var name = texture.name;
                    if ( textureImages[ name ] == undefined ) {
                        textureImages[ name ] = { 
                            name: name,
                            maps: [ key ],
                            data: texture.sourceFile.split(";base64,").pop(), // important!
                            type: texture.sourceFile.split(";base64,").shift().replace("data:", ""),
                        };
                    }
                }
            });

            debugMode && console.log( "first pass:", deepCopy(textureImages) );

        //  Second pass (collect mapkeys).

            textureMaps.forEach(function( key ){
                if ( !doc[ key ] ) return;
                var texture = doc[ key ];
            //  It is a "fake" texture, not real one.
                var name = texture.name;
                if ( !textureImages[ name ].maps.includes(key) )
                    textureImages[ name ].maps.push( key );
            });

            debugMode && console.log( "second pass:", textureImages );

        //  Third pass (upload images in background).

        //  var uploads = [];

            for (var name in textureImages ) {

                (function(){

                    var item = textureImages[ name ];
                //  debugMode && console.log({"item": item});

                    var selector = {_id:json._id};

                    uploads.push( function(){
                        new Promise(function(resolve, reject){

                            var formdata = new FormData();
                            formdata.append("type",  item.type);
                            formdata.append("image", item.data);
                            formdata.append("name",  item.name);
                            formdata.append("title", item.name);

                            var clientid = "95e1ecaf14ca5e6";
                            var endpoint = "https://api.imgur.com/3/image";
                            var xhttp = new XMLHttpRequest();
                            xhttp.open('POST', endpoint, true);
                            xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
                            xhttp.onreadystatechange = function () {
                                if (this.readyState === 4) {
                                    var response = "";
                                    if (this.status >= 200 && this.status < 300) {
                                        response = JSON.parse(this.responseText);
                                        resolve( response ); // resolve promise.
                                    } else {
                                        var err = JSON.parse(this.responseText).data.error;
                                        console.error( err.type, err );
                                        throw err;
                                    }
                                }
                            };

                            xhttp.send(formdata);
                            xhttp = null;

                        }).then( function( response ){

                            var data = response.data;

                            //  var link = data.link;
                            //  var selector = {_id: doc._id};
                            //  debugMode && console.log({"data": data});

                            var modifier = {$set:{}};

                            item.maps.forEach(function(mapkey){

                                var imagekey = mapkey + ".image";
                                var sourcekey = mapkey + ".sourceFile";
                                modifier.$set[ imagekey ] = data.link;
                                modifier.$set[ sourcekey ] = data.link;

                            //  texture matadata. (optional).
                                var mapMetakey = mapkey + ".meta";
                                modifier.$set[ mapMetakey ] = data;
                                var mtlMetakey = "meta." + mapkey;
                                modifier.$set[ mtlMetakey ] = data;

                            });

                            debugMode && console.log(modifier);

                            collection.update(selector, modifier, function(err){
                                if (err) throw err;
                            }).then( function(){

                            //  Success.
                                bootbox.dialog({
                                    size: "small",
                                    className: "middle",
                                    title: `<div class="alert-icon icon-success"></div>`
                                         + `<h2 style="margin:auto;">Success</h2>`,
                                    message: `<div>Texture ${data.name} uploaded successfully!</div>`,
                                    buttons: {
                                        success: {
                                            label: 'Close',
                                            className: 'btn-success',
                                        }
                                    },
                                });

                            }).catch(function(err){
                                console.error(err);
                                throw err;
                            });

                            return data;

                        }).then( function( data ){

                        //  Add to cache.
                            caches.open("textures").then(function(cache){
                                cache.add(data.link);
                            });

                        }).catch(function(err){
                            bootbox.dialog({
                                size: "small",
                                className: "middle",
                                title: `<div class="alert-icon icon-error"></div>`
                                     + `<h2 style="margin:auto;">Error!</h2>`,
                                message: `<div>Sorry! An error occurred.</div>'
                                       + '<div>${err}</div>`,
                                buttons: {
                                    cancel: {
                                        label: 'Close',
                                        className: 'btn-default',
                                    },
                                },
                            });
                            console.error(err);
                        });

                    }); // end of push.

                })();

            }

            debugMode && console.log("uploads:", uploads);

        /*
            if ( navigator.onLine ) {

                while( uploads.length ){
                    uploads.shift().call();
                }

            } else {

                $(window).one("online", function(){
                    while( uploads.length ){
                        uploads.shift().call();
                    }
                });

            }
        */

        //  or immidiatly...

            while( uploads.length ){
                uploads.shift().call();
            }

            return;

        }).catch(function(err){
        //  Error.
            bootbox.dialog({
                size: "small",
                className: "middle",
                title: `<div class="alert-icon icon-error"></div>`
                     + `<h2 style="margin:auto;">Error!</h2>`,
                message: `<div>Sorry! An error occurred.</div>`
                       + `<div>${err}</div>`,
                buttons: {
                    cancel: {
                        label: 'Close',
                        className: 'btn-default',
                    },
                },
            });
            console.error(err);
        });

    });

});

//  multiFilter.js

/**
 * Filters an array of objects with multiple criteria.
 * source: "https://gist.github.com/jherax/f11d669ba286f21b7a2dcff69621eb72"
 * @param  {Array}  array: the array to filter
 * @param  {Object} filters: an object with the filter criteria as the property names
 * @return {Array}
 */
/*
    function multiFilter(array, filters) {
        const filterKeys = Object.keys(filters);
    //  filters all elements passing the criteria.
        return array.filter((item) => {
        //  dynamically validate all filter criteria.
            return filterKeys.every(key => {
            //  ignores an empty filter.
                if (!filters[key].length) return true;
                return filters[key].includes(item[key]);
            });
        });
    }
*/
</script>
